# MileageReward
Java Spring 3.x, mysql
# 🚀 Mileage Reward Referral Job

Spring Boot scheduled job to calculate and distribute mileage rewards, including referral bonuses.

---

## 📦 Project Features

- ✅ Scheduled job using `@Scheduled(cron = "...")`
- ✅ Rewards 1% for user, 0.1% for referrer (if exists)
- ✅ JPA Entity & Repository for `Users`, `Rides`, `RewardTransaction`
- ✅ Unit test with Mockito
- ✅ Docker & Docker Compose setup with MySQL
- ✅ Cron configuration via `application.properties`

---

## 🧱 Prerequisites

- Java 17
- Gradle
- Docker & Docker Compose
- MySQL client (for database setup)

---

## ⚙️ Build Application

```bash
./gradlew clean bootJar
```

This will generate `build/libs/mileage-job.jar`.

---

## 🐳 Run with Docker Compose

```bash
docker compose -f docker/docker-compose.yml up --build
```

This will:

- Build the Spring Boot app image
- Start `mysql` container
- Run the reward job app (cron runs automatically)

---

## 🗃️ Database Initialization & Test Data

### 1. Create the Database and Schema

Use the following command to create the new database and all tables.
Run this in your terminal (command line) with the MySQL client:

```bash
mysql -u <username> -p < mileage_schema.sql
```

* Replace `<username>` with your MySQL username.
* Enter your password when prompted.
* This command will execute all statements in `mileage_schema.sql` and create the `mileage_test` database with its schema.

### 2. Load Sample Test Data

Once the schema is created, run the following command to populate sample data:

```bash
mysql -u <username> -p mileage_test < sample_data.sql
```

* This will insert sample test data into your `mileage_test` database.
* You can now query and test your Mileage Reward module with real data.

> **Tips:**
>
> * Make sure you are in the same directory as the `.sql` files, or use the full path to each file.
> * You can verify data using a tool like MySQL Workbench or by logging in with `mysql -u <username> -p mileage_test` and running `SHOW TABLES;` or `SELECT * FROM k_users LIMIT 10;`

## 🛠 Configuration

Update `src/main/resources/application.properties`:

```properties
job.mileage.reward.cron=0 0 2 * * *   # Run daily at 2:00 AM
spring.datasource.url=jdbc:mysql://mysql:3306/mileage
spring.datasource.username=mileage_user
spring.datasource.password=mileage_pass
```

---

## ✅ Testing

Run unit tests:

```bash
./gradlew test
```

Tests include:
- Reward point logic
- Referral handling
- Error logging

---

## 📝 Notes

- Logs are stored in `/app/logs` in the container (mapped via volume)
- Timezone is set to `Asia/Ha_Noi` by default

---

## 📄 Author

Generated by request for Mileage Reward System with Referral Support.